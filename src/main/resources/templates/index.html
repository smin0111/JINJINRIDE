<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINJIN RIDE - 중개수수료 결제</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://nsp.pay.naver.com/sdk/js/naverpay.min.js"></script>
</head>
<body>
<main class="frame">
    <section class="background-text-wrapper">
        <div class="background-text">
            <div class="overlap">
                <div class="main-text">
                    <div class="overlap-group">
                        <h1 class="text-wrapper">JINJIN</h1>
                        <h1 class="div">RIDE</h1>
                    </div>
                </div>
                <div class="overlap-wrapper">
                    <div class="overlap-group">
                        <span class="text-wrapper-2" aria-hidden="true">JINJIN</span>
                        <span class="text-wrapper-3" aria-hidden="true">RIDE</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ✅ 가맹점 선택 및 결제 버튼 -->
    <section style="text-align: center; margin-top: 40px;">
        <label for="merchantSelect">가맹점 선택:</label>
        <select id="merchantSelect" class="px-3 py-2 rounded border">
            <option value="">선택하세요</option>
        </select>
        <br><br>
        <input type="button" id="naverPayBtn" value="중개수수료 결제">
    </section>
</main>

<script>
    const oPay = Naver.Pay.create({
        mode: "development",
        clientId: "HN3GGCMDdTgGUfl0kFCo",
        chainId: "VlFlWlFJVzB2Z2t"
    });

    let selectedMerchantId = null;

    // 페이지 로딩 시 가맹점 목록 불러오기
    async function loadMerchants() {
        const res = await fetch("http://localhost:8001/api/merchant/all"); // 전체 가맹점 조회 API
        const data = await res.json();
        const select = document.getElementById("merchantSelect");
        data.forEach(merchant => {
            select.innerHTML += `<option value="${merchant.merchantNum}">${merchant.merchantNm}</option>`;
        });
    }

    document.getElementById("merchantSelect").addEventListener("change", (e) => {
        selectedMerchantId = e.target.value;
    });

    async function getMerchantFee(merchantId) {
        const res = await fetch(`http://localhost:8001/api/merchant/${merchantId}/fee`);
        if (!res.ok) throw new Error("중개수수료 조회 실패");
        return await res.json();
    }

    async function initiatePay() {
        if (!selectedMerchantId) {
            alert("가맹점을 선택하세요.");
            return;
        }

        const fee = await getMerchantFee(selectedMerchantId);

        oPay.open({
            merchantPayKey: `MERCHANT-${selectedMerchantId}-${Date.now()}`,
            productName: "중개수수료 결제",
            productCount: "1",
            totalPayAmount: String(fee),
            taxScopeAmount: String(fee),
            taxExScopeAmount: "0",
            returnUrl: `http://localhost:8001/payment/return?merchantId=${selectedMerchantId}`
        });
    }

    document.getElementById("naverPayBtn").addEventListener("click", initiatePay);

    // 초기 가맹점 로딩
    loadMerchants();
</script>
</body>
</html>
